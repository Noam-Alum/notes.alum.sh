# Boot loaders

> For a boot overview refere to this [page](page.php?page=docs/Linux/Boot_process/boot_process.md).

| **Name** | **Release date** |                           **In use?**                          |
|:--------:|:----------------:|:--------------------------------------------------------------:|
| lilo     | 1992             | Up until 2000s                                                 |
| Grub 1   | June 17, 1999    | Up until 2009                                                  |
| Grub 2   | 2009             | By 2012, most major Linux distributions had switched to GRUB 2 |

*Fun fact* - grub 1 was never actualy "grub 1" the latest release was 0.9.

## Types of bootloaders

A boot loader is a small program that loads the operating system (OS) into the computer's memory when the system is powered on or restarted.
It is an essential component of the boot process, bridging the gap between the system's firmware (such as BIOS or UEFI) and the operating system.

### Grub version 1 (Legacy)

By default GRUB 1 is installed in `/boot/grub` and its main configuration file is in `/boot/grub/menu.lst`, but nowdays some distributions link this to `/boot/grub/grub.conf` since most users are used to this path more than the other.

A sample grub 1 configuration consists of two sections, the gloabl configs and the different kernel/initram or chainloader options.

<u>**The global configs are:**</u>

|**Config** |**Description**                                             |
|-----------|------------------------------------------------------------|
|#          |Comment                                                     |
|color      |Foreground and background colors for normal and active items|
|default    |Which boot menu item is the default                         |
|fallback   |Which boot menu should be used if the default fails         |
|hiddenmenu |Hide the menu options                                       |
|splashimage|Show this image in the background!                          |
|timeout    |Wait this much and then start the default                   |
|password   |Security is important! Will ask this password               |
|savedefault|Remember the last booted item                               |

<u>**And on the second part we have these directives:**</u>

|**Config**  |**Description**                                                                                                |
|------------|---------------------------------------------------------------------------------------------------------------|
|title       |Defines the section name                                                                                       |
|root        |Disk and partition where /boot directory is. In the form of (hddrive, partition), say (hd0, 0) or (hd0, msdos0)|
|kernel      |Kernel image file name in /boot                                                                                |
|initrd      |Initramfs file in /boot                                                                                        |
|rootnoverify|Defines a non-Linux root partition                                                                             |
|chainloader |Another file will act as stage 1 loader. Used for booting Windows systems                                      |

<u>**Sample grub 1 configuration:**</u>

```bash
# grub.conf generated by anaconda
#
# Note that you do not have to rerun grub after making changes to this file
# NOTICE:  You do not have a /boot partition.  This means that
#          all kernel and initrd paths are relative to /, eg.
#          root (hd0,5)
#          kernel /boot/vmlinuz-version ro root=/dev/sda6
#          initrd /boot/initrd-version.img
#boot=/dev/sda6
default=1
timeout=10
splashimage=(hd0,5)/boot/grub/splash.xpm.gz
#hiddenmenu
password --md5 $1$RW1VW/$4XGAklxB7/GJk0uO47Srx1
title Upgrade to Fedora 11 (Leonidas)
    kernel /boot/upgrade/vmlinuz preupgrade \
      repo=hd::/var/cache/yum/preupgrade stage2=\
      hd:UUID=8b4c62e7-2022-4288-8995-5eda92cd149b:/boot/upgrade/install.img \
      ks=hd:UUID=8b4c62e7-2022-4288-8995-5eda92cd149b:/boot/upgrade/ks.cfg
    initrd /boot/upgrade/initrd.img
title Fedora (2.6.26.8-57.fc8)
    root (hd0,5)
    kernel /boot/vmlinuz-2.6.26.8-57.fc8 ro root=LABEL=FEDORA8 rhgb quiet
    initrd /boot/initrd-2.6.26.8-57.fc8.img
title Fedora (2.6.26.6-49.fc8)
    root (hd0,5)
    kernel /boot/vmlinuz-2.6.26.6-49.fc8 ro root=LABEL=FEDORA8 rhgb quiet
    initrd /boot/initrd-2.6.26.6-49.fc8.img
title GRUB Menu
    rootnoverify (hd0,1)
    chainloader +1
title Windows
    rootnoverify (hd0,0)
    chainloader +1
```

##### GRUB 1 commands

- **grub-install:** Afte configuring GRUB you need to install the grub on a disks **MBR** (**M**aster **B**oot **R**ecord), to do this you can use two different approaches:
    ```bash
    grub-install /dev/fd0
    grub-install '(fd0)'
    ```
Just like any other boot manager, you can install grub on a CD, floppy, MBR (/dev/sda, /dev/sdb, ..) or a partition (/dev/sdb2, /dev/sda6, ..), but if you want to install it on anywhere other than the MBR, use a **chainloader** to point your boot sequence toward it.

> **Chain loading:** is when a boot loader loads another boot loader.
    This is done for exmpale, when a Windows bootloader needs to start a Linux system
    ![chain loading](https://www.akadia.com/img/dual_boot_chainloading.gif)

##### Interacting with GRUB 1

If you press `c` on the grub menu, you will go into the **GRUB Command Line** or **GRUB shell**, there you can type commands like `root`, `kernel`, `initrd` and boot the system with `boot` or press the `Esc` key to return back to the menu.

---

### Grub 2

The most common bootloader now days, on BIOS systems it's installed in `/boot/grub/` or `/boot/grub2` and on UEFI systems it's installed in `/boot/efi/EFI/distro-name`.

Grub 2s configuring file is called `grub.cfg`, here's a simplified example:
```bash
set default="0"
menuentry "Fedora" { 
  set root=(hd0,1)
  linux /boot/vmlinuz-5.10.0-9-arm64 ro quiet
  initrd /boot/initrd.img-5.10.0-9-arm64
}
menuentry "Windows" {
  chainloader (hd1,msdos2)+1
}
```

> Unlike GRUB 1, we use Linux-style numbering for partitions.

<u>**List of options:**</u>

|**Option**    |**Descriptioni**                                        |
|--------------|--------------------------------------------------------|
|menuentry     |Defines a new menuentry                                 |
|set root      |Defines the root where /boot located                    |
|linux, linux16|Defines the location of the Linux kernel on BIOS systems|
|linuxefi      |Defines the Linux kernel on UEFI systems                |
|initrd        |Defines the initramfs image for BIOS systems            |
|initrdefi     |Defines the initramfs image for UEFI systems            |

Real life GRUB 2 configuration

```bash
#
# DO NOT EDIT THIS FILE
#
# It is automatically generated by grub-mkconfig using templates
# from /etc/grub.d and settings from /etc/default/grub
#

### BEGIN /etc/grub.d/00_header ###
if [ -s $prefix/grubenv ]; then
  set have_grubenv=true
  load_env
fi
if [ "${next_entry}" ] ; then
   set default="${next_entry}"
   set next_entry=
   save_env next_entry
   set boot_once=true
else
   set default="0"
fi

if [ x"${feature_menuentry_id}" = xy ]; then
  menuentry_id_option="--id"
else
  menuentry_id_option=""
fi

export menuentry_id_option

if [ "${prev_saved_entry}" ]; then
  set saved_entry="${prev_saved_entry}"
  save_env saved_entry
  set prev_saved_entry=
  save_env prev_saved_entry
  set boot_once=true
fi

function savedefault {
  if [ -z "${boot_once}" ]; then
    saved_entry="${chosen}"
    save_env saved_entry
  fi
}
function load_video {
  if [ x$feature_all_video_module = xy ]; then
    insmod all_video
  else
    insmod efi_gop
    insmod efi_uga
    insmod ieee1275_fb
    insmod vbe
    insmod vga
    insmod video_bochs
    insmod video_cirrus
  fi
}

if [ x$feature_default_font_path = xy ] ; then
   font=unicode
else
insmod part_gpt
insmod ext2
if [ x$feature_platform_search_hint = xy ]; then
  search --no-floppy --fs-uuid --set=root  df2d9e14-f1e9-4b1b-95d4-0167caa2461e
else
  search --no-floppy --fs-uuid --set=root df2d9e14-f1e9-4b1b-95d4-0167caa2461e
fi
    font="/usr/share/grub/unicode.pf2"
fi

if loadfont $font ; then
  set gfxmode=auto
  load_video
  insmod gfxterm
  set locale_dir=$prefix/locale
  set lang=en_US
  insmod gettext
fi
terminal_output gfxterm
if [ "${recordfail}" = 1 ] ; then
  set timeout=30
else
  if [ x$feature_timeout_style = xy ] ; then
    set timeout_style=menu
    set timeout=5
  # Fallback normal timeout code in case the timeout_style feature is
  # unavailable.
  else
    set timeout=5
  fi
fi
### END /etc/grub.d/00_header ###

### BEGIN /etc/grub.d/05_debian_theme ###
insmod part_gpt
insmod ext2
if [ x$feature_platform_search_hint = xy ]; then
  search --no-floppy --fs-uuid --set=root  df2d9e14-f1e9-4b1b-95d4-0167caa2461e
else
  search --no-floppy --fs-uuid --set=root df2d9e14-f1e9-4b1b-95d4-0167caa2461e
fi
insmod png
if background_image /usr/share/desktop-base/homeworld-theme/grub/grub-4x3.png; then
  set color_normal=white/black
  set color_highlight=black/white
else
  set menu_color_normal=cyan/blue
  set menu_color_highlight=white/blue
fi
### END /etc/grub.d/05_debian_theme ###

### BEGIN /etc/grub.d/10_linux ###
function gfxmode {
    set gfxpayload="${1}"
}
set linux_gfx_mode=
export linux_gfx_mode
menuentry 'Debian GNU/Linux' --class debian --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-simple-df2d9e14-f1e9-4b1b-95d4-0167caa2461e' {
    load_video
    insmod gzio
    if [ x$grub_platform = xxen ]; then insmod xzio; insmod lzopio; fi
    insmod part_gpt
    insmod ext2
    if [ x$feature_platform_search_hint = xy ]; then
      search --no-floppy --fs-uuid --set=root  df2d9e14-f1e9-4b1b-95d4-0167caa2461e
    else
      search --no-floppy --fs-uuid --set=root df2d9e14-f1e9-4b1b-95d4-0167caa2461e
    fi
    echo    'Loading Linux 5.10.0-9-arm64 ...'
    linux   /boot/vmlinuz-5.10.0-9-arm64 root=UUID=df2d9e14-f1e9-4b1b-95d4-0167caa2461e ro  quiet
    echo    'Loading initial ramdisk ...'
    initrd  /boot/initrd.img-5.10.0-9-arm64
}
submenu 'Advanced options for Debian GNU/Linux' $menuentry_id_option 'gnulinux-advanced-df2d9e14-f1e9-4b1b-95d4-0167caa2461e' {
    menuentry 'Debian GNU/Linux, with Linux 5.10.0-9-arm64' --class debian --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-5.10.0-9-arm64-advanced-df2d9e14-f1e9-4b1b-95d4-0167caa2461e' {
        load_video
        insmod gzio
        if [ x$grub_platform = xxen ]; then insmod xzio; insmod lzopio; fi
        insmod part_gpt
        insmod ext2
        if [ x$feature_platform_search_hint = xy ]; then
          search --no-floppy --fs-uuid --set=root  df2d9e14-f1e9-4b1b-95d4-0167caa2461e
        else
          search --no-floppy --fs-uuid --set=root df2d9e14-f1e9-4b1b-95d4-0167caa2461e
        fi
        echo    'Loading Linux 5.10.0-9-arm64 ...'
        linux   /boot/vmlinuz-5.10.0-9-arm64 root=(hd0,1) ro  quiet
        echo    'Loading initial ramdisk ...'
        initrd  /boot/initrd.img-5.10.0-9-arm64
    }
    menuentry 'Debian GNU/Linux, with Linux 5.10.0-8-arm64 (recovery mode)' --class debian --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-5.10.0-8-arm64-recovery-df2d9e14-f1e9-4b1b-95d4-0167caa2461e' {
        load_video
        insmod gzio
        if [ x$grub_platform = xxen ]; then insmod xzio; insmod lzopio; fi
        insmod part_gpt
        insmod ext2
        if [ x$feature_platform_search_hint = xy ]; then
          search --no-floppy --fs-uuid --set=root  df2d9e14-f1e9-4b1b-95d4-0167caa2461e
        else
          search --no-floppy --fs-uuid --set=root df2d9e14-f1e9-4b1b-95d4-0167caa2461e
        fi
        echo    'Loading Linux 5.10.0-8-arm64 ...'
        linux   /boot/vmlinuz-5.10.0-8-arm64 root=UUID=df2d9e14-f1e9-4b1b-95d4-0167caa2461e ro single 
        echo    'Loading initial ramdisk ...'
        initrd  /boot/initrd.img-5.10.0-8-arm64
    }
}

### END /etc/grub.d/10_linux ###

### BEGIN /etc/grub.d/20_linux_xen ###

### END /etc/grub.d/20_linux_xen ###

### BEGIN /etc/grub.d/30_os-prober ###
### END /etc/grub.d/30_os-prober ###

### BEGIN /etc/grub.d/30_uefi-firmware ###
menuentry 'System setup' $menuentry_id_option 'uefi-firmware' {
    fwsetup
}
### END /etc/grub.d/30_uefi-firmware ###

### BEGIN /etc/grub.d/40_custom ###
# This file provides an easy way to add custom menu entries.  Simply type the
# menu entries you want to add after this comment.  Be careful not to change
# the 'exec tail' line above.
### END /etc/grub.d/40_custom ###

### BEGIN /etc/grub.d/41_custom ###
if [ -f  ${config_directory}/custom.cfg ]; then
  source ${config_directory}/custom.cfg
elif [ -z "${config_directory}" -a -f  $prefix/custom.cfg ]; then
  source $prefix/custom.cfg;
fi
### END /etc/grub.d/41_custom ###
```
